<!DOCTYPE html>
<html lang="en">

<head>
    <title>Scribble.rs - Game</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="/resources/style.css" />
    <link rel="stylesheet" type="text/css" href="/resources/lobby.css" />
    <link rel="stylesheet" type="text/css" href="/resources/lobby_players.css" />
    <link rel="icon" type="image/png" href="/resources/favicon.png" />
</head>

<body>
    <noscript><span class="noscript">Hey, seems like you've disabled JavaScript.
            I get it ... but you are trying to play an interactive drawing game
            here, so you have to turn on JavaScript.</span></noscript>
    <div class="content-wrapper">
        <div class="lobby-layout">
            <span id="rounds">Round {{.Round}} of {{.Rounds}}</span>
            <div id="word-container">
                {{template "word" .WordHints}}
            </div>
            <span id="time-left">Time Left: âˆž</span>

            <div id="player-container">
                {{template "players" .Players}}
            </div>
            <div>
                <canvas id="drawing-board" width="1100" height="600"></canvas>
                <div style="display: flex; flex-direction: row;">
                    <input type="color" id="color-picker" onchange="setColor()" value="#000000">
                    <button onclick="clearCanvas()">Clear canvas</button>
                </div>
            </div>
            <div class="chat">
                <div id="message-container"></div>
                <form class="message-input-form" onsubmit="return sendMessage()">
                    <input id="message-input" type="text" placeholder="Type your message" />
                </form>
            </div>
        </div>
    </div>

    {{template "footer"}}

    <script>
        function httpGetAsync(theUrl, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", theUrl, true);
            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        callback(xhr);
                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };
            xhr.onerror = function (e) {
                console.error(xhr.statusText);
            };
            xhr.send(null);
        }

        console.log("Attempting Connection...");
        const socket = new WebSocket("ws://" + location.hostname + ":{{.Port}}/ws?id={{.LobbyID}}");

        const messageInput = document.getElementById("message-input");
        const playerContainer = document.getElementById("player-container");
        const wordContainer = document.getElementById("word-container");
        const messageContainer = document.getElementById("message-container");
        const roundsSpan = document.getElementById("rounds");
        const drawingBoard = document.getElementById("drawing-board")
        const context = drawingBoard.getContext("2d");
        const colorPicker = document.getElementById("color-picker")

        var allowDrawing = false;
        var color = "black";

        function setColor() {
            color = colorPicker.value;
        }

        function clearCanvas() {
            socket.send(JSON.stringify({ Type: "clear-drawing-board" }));
        }

        const sendMessage = () => {
            socket.send(JSON.stringify({ Type: "message", Data: messageInput.value }));
            messageInput.value = "";

            // Necessary in order to keep the page from submitting.
            return false;
        }

        new MutationObserver(
            () => { messageContainer.scrollTop = messageContainer.scrollHeight; }
        ).observe(messageContainer, { attributes: false, childList: true, subtree: false });

        socket.onopen = () => {
            console.log("Successfully Connected");
        };

        socket.onmessage = event => {
            var parsed = JSON.parse(event.data);
            if (parsed.Type === "update-players") {
                httpGetAsync("/lobby/players?id={{.LobbyID}}", response => {
                    playerContainer.innerHTML = response.responseText;
                });
            } else if (parsed.Type === "update-wordhint") {
                httpGetAsync("/lobby/wordhint?id={{.LobbyID}}", response => {
                    wordContainer.innerHTML = response.responseText;
                });
            } else if (parsed.Type === "update-rounds") {
                httpGetAsync("/lobby/rounds?id={{.LobbyID}}", response => {
                    roundsSpan.innerText = response.responseText;
                });
            } else if (parsed.Type === "message") {
                messageContainer.innerHTML += `<div class="message">
                        <span class="chat-name">` + parsed.Data.Author + `</span>
                        <span class="message-content">` + parsed.Data.Content + `</span>
                    </div>`;
            } else if (parsed.Type === "persist-username") {
                //TODO GMT date for consistency?
                document.cookie = "username=" + parsed.Data + ";expires=Tue, 19 Jan 2038 03:14:07 UTC;path=/;samesite=strict";
            } else if (parsed.Type === "reset-username") {
                document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 GMT";
            } else if (parsed.Type === "pixel") {
                drawLine(context, parsed.Data.FromX, parsed.Data.FromY, parsed.Data.ToX, parsed.Data.ToY, parsed.Data.Color, parsed.Data.LineWidth);
            } else if (parsed.Type === "clear-drawing-board") {
                context.clearRect(0, 0, drawingBoard.width, drawingBoard.height);
            } else if (parsed.Type === "next-turn") {
                context.clearRect(0, 0, drawingBoard.width, drawingBoard.height);
                allowDrawing = false;
            } else if (parsed.Type === "your-turn") {
                allowDrawing = true;
            }
        };

        socket.onclose = event => {
            console.log("Socket Closed Connection: ", event);
        };

        socket.onerror = error => {
            console.log("Socket Error: ", error);
        };

        var isDrawing = false;
        var x = 0;
        var y = 0;

        const rect = drawingBoard.getBoundingClientRect();

        drawingBoard.onmouseleave = function (e) {
            x = 0;
            y = 0;
            isDrawing = false
        }

        drawingBoard.onmousedown = function (e) {
            if (allowDrawing) {
                x = e.layerX - rect.left;
                y = e.layerY - rect.top;
                isDrawing = true;
            }
        };

        drawingBoard.onmousemove = function (e) {
            if (allowDrawing && isDrawing === true) {
                drawLineAndSendEvent(context, x, y, e.layerX - rect.left, e.layerY - rect.top, color, 1);
                x = e.layerX - rect.left;
                y = e.layerY - rect.top;
            }
        };

        drawingBoard.onmouseup = function (e) {
            if (isDrawing === true) {
                x = 0;
                y = 0;
                isDrawing = false;
            }
        };

        drawingBoard.onclick = function (e) {
            if (allowDrawing) {
                x = e.layerX - rect.left
                y = e.layerY - rect.top
                drawLineAndSendEvent(context, x - 1, y - 1, x, y, color, 1)
                x = 0
                y = 0
                isDrawing = false
            }
        }

        function drawLine(context, x1, y1, x2, y2, color, lineWidth) {
            context.beginPath();
            context.strokeStyle = color;
            context.lineWidth = lineWidth;
            context.moveTo(x1, y1);
            context.lineTo(x2, y2);
            context.stroke();
            context.closePath();
        }

        function drawLineAndSendEvent(context, x1, y1, x2, y2, color, lineWidth) {
            drawLine(context, x1, y1, x2, y2, color, lineWidth)
            socket.send(JSON.stringify({
                Type: "pixel", Data: {
                    FromX: x1,
                    FromY: y1,
                    ToX: x2,
                    ToY: y2,
                    Color: color,
                    LineWidth: 1,
                }
            }));

        }
    </script>
</body>

</html>