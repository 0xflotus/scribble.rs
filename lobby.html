<!DOCTYPE html>
<html lang="en">

<head>
    <title>Scribble.rs - Game</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="/resources/style.css" />
    <link rel="stylesheet" type="text/css" href="/resources/lobby.css" />
    <link rel="stylesheet" type="text/css" href="/resources/lobby_players.css" />
    <link rel="icon" type="image/png" href="/resources/favicon.png" />
</head>

<body>
    <noscript><span class="noscript">Hey, seems like you've disabled JavaScript.
            I get it ... but you are trying to play an interactive drawing game
            here, so you have to turn on JavaScript.</span></noscript>
    <div class="content-wrapper">
        <div class="lobby-layout">
            <span id="rounds">Round {{.Round}} of {{.Rounds}}</span>
            <div id="word-container">
                {{template "word" .WordHints}}
            </div>
            <span id="time-left">Time Left: âˆž</span>

            <div id="player-container">
                {{template "players" .Players}}
            </div>
            <canvas class="drawing-board"></canvas>
            <div class="chat">
                <div id="message-container"></div>
                <form class="message-input-form" onsubmit="return sendMessage()">
                    <input id="message-input" type="text" placeholder="Type your message" />
                </form>
            </div>
        </div>
    </div>

    {{template "footer"}}

    <script>
        function httpGetAsync(theUrl, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", theUrl, true);
            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        callback(xhr);
                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };
            xhr.onerror = function (e) {
                console.error(xhr.statusText);
            };
            xhr.send(null);
        }

        console.log("Attempting Connection...");
        const socket = new WebSocket("ws://" + location.hostname + ":{{.Port}}/ws?id={{.LobbyID}}");

        const messageInput = document.getElementById("message-input");
        const playerContainer = document.getElementById("player-container");
        const wordContainer = document.getElementById("word-container");
        const messageContainer = document.getElementById("message-container");
        const roundsSpan = document.getElementById("rounds");

        const sendMessage = () => {
            socket.send(JSON.stringify({ Type: "message", Data: messageInput.value }));
            messageInput.value = "";

            // Necessary in order to keep the page from submitting.
            return false;
        }

        socket.onopen = () => {
            console.log("Successfully Connected");
        };

        socket.onmessage = event => {
            var parsed = JSON.parse(event.data);
            if (parsed.Type === "update-players") {
                httpGetAsync("/lobby/players?id={{.LobbyID}}", response => {
                    playerContainer.innerHTML = response.responseText;
                });
            } else if (parsed.Type === "update-wordhint") {
                httpGetAsync("/lobby/wordhint?id={{.LobbyID}}", response => {
                    wordContainer.innerHTML = response.responseText;
                });
            } else if (parsed.Type === "update-rounds") {
                httpGetAsync("/lobby/rounds?id={{.LobbyID}}", response => {
                    roundsSpan.innerText = response.responseText;
                });
            } else if (parsed.Type === "message") {
                messageContainer.innerHTML += `<div class="message">
                        <span class="chat-name">` + parsed.Data.Author + `</span>
                        <span class="message-content">` + parsed.Data.Content + `</span>
                    </div>`;
            }
        };

        socket.onclose = event => {
            console.log("Socket Closed Connection: ", event);
        };

        socket.onerror = error => {
            console.log("Socket Error: ", error);
        };
    </script>
</body>

</html>